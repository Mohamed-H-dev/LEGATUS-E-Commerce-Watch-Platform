<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="./css/all.min.css" />
    <link rel="stylesheet" href="./css/bootstrap.min.css" />
    <link rel="stylesheet" href="./css/Cart.css " />
    <script src="./js/all.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>

    <script>
      window.addEventListener("load", function () {
        // JSON.parse(localStorage.getItem("Cart"));
        // Get cart data from localStorage
        let cartData = JSON.parse(localStorage.getItem("Cart")) || [];
        const cartTableBody = document.getElementById("cart-table-body");
        const cartMobileList = document.getElementById("cart-mobile-list");

        // Function to render cart items
        function renderCartItems() {
          // Clear any existing rows/cards
          cartTableBody.innerHTML = "";
          cartMobileList.innerHTML = "";

          // Array to store all products data for calculations
          let cartItems = [];

          // Create a row/card for each item in the cart
          cartData.forEach((item, index) => {
            const product = item.product;
            const priceValue = parseFloat(product.price.split(" ")[0]);
            const quantity = product.quantity_in_cart;
            const total = (priceValue * quantity).toFixed(2);

            // Store product data for calculations
            cartItems.push({
              name: product.name,
              id: product.id,
              color: product.color,
              image: product.image,
              price: priceValue,
              quantity: quantity,
              maxQuantity: product.max_quantity,
              total: parseFloat(total),
              index: index,
            });

            // Desktop table row
            const row = document.createElement("tr");
            row.className = "cart-item";
            row.dataset.index = index;

            row.innerHTML = `
              <td class="d-flex align-items-center">
                <img
                  src="${product.image}"
                  alt="${product.name}"
                  class="img-fluid me-3"
                  style="max-width: 60px"
                  product-name="${product.name}"
                  product-id="${product.id}"
                  product-color="${product.color}"
                  product-image="${product.image}"
                  product-price="${product.price}"
                  product-quantity-in-cart="${product.quantity_in_cart}"
                  product-max-quantity="${product.max_quantity}"
                />
                <div>
                  <p class="product-name mb-1 fw-bold">${product.name}</p>
                  <p class="product-id mb-1 small text-muted">ID: ${product.id}</p>
                  <p class="product-color small text-muted">Color: ${product.color}</p>
                </div>
              </td>
              <td class="product-price text-center">${product.price}</td>
              <td class="text-center">
                <div class="d-flex justify-content-center quantity-controls">
                  <button class="btn btn-sm quantity-minus">
                    <i class="fas fa-minus"></i>
                  </button>
                  <span class="mx-2 quantity-value fw-bold">${product.quantity_in_cart}</span>
                  <button class="btn btn-sm quantity-plus">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </td>
              <td class="product-total text-center fw-bold">${total} $</td>
              <td class="text-center">
                <button class="btn btn-sm btn-danger delete-item" data-index="${index}">
                  <i class="fa-solid fa-xmark"></i>               
                </button>
              </td>
            `;

            cartTableBody.appendChild(row);

            // Mobile card
            const card = document.createElement("div");
            card.className = "card mb-3 cart-item";
            card.dataset.index = index;

            card.innerHTML = `
              <div class="card-body">
                <div class="row">
                  <div class="col-4">
                    <img
                      src="${product.image}"
                      alt="${product.name}"
                      class="product-img-mobile img-fluid"
                      product-name="${product.name}"
                      product-id="${product.id}"
                      product-color="${product.color}"
                      product-image="${product.image}"
                      product-price="${product.price}"
                      product-quantity-in-cart="${product.quantity_in_cart}"
                      product-max-quantity="${product.max_quantity}"
                    />
                  </div>
                  <div class="col-8">
                    <div class="d-flex justify-content-between">
                      <div>
                        <p class="product-name mb-1 fw-bold">${product.name}</p>
                        <p class="product-id mb-1 small text-muted">ID: ${product.id}</p>
                        <p class="product-color small text-muted mb-2">Color: ${product.color}</p>
                      </div>
                      <button class="btn btn-sm btn-danger delete-item align-self-start" data-index="${index}">
                        <i class="fa-solid fa-xmark"></i>       
                      </button>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center quantity-controls">
                        <button class="btn btn-sm quantity-minus">
                          <i class="fas fa-minus"></i>
                        </button>
                        <span class="mx-2 quantity-value fw-bold">${product.quantity_in_cart}</span>
                        <button class="btn btn-sm quantity-plus">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                      <span class="product-price fw-bold">${product.price}</span>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-2">
                      <span class="text-muted">Total:</span>
                      <span class="product-total fw-bold">${total} $</span>
                    </div>
                  </div>
                </div>
              </div>
            `;

            cartMobileList.appendChild(card);
          });

          // Initialize quantity controls for all items
          document.querySelectorAll(".cart-item").forEach((item) => {
            const img = item.querySelector("img[product-image]");
            img.src = img.getAttribute("product-image");

            // Get product data
            const product = {
              name: img.getAttribute("product-name"),
              id: img.getAttribute("product-id"),
              color: img.getAttribute("product-color"),
              price: parseFloat(
                img.getAttribute("product-price").split(" ")[0]
              ),
              quantity: parseInt(img.getAttribute("product-quantity-in-cart")),
              maxQuantity: parseInt(img.getAttribute("product-max-quantity")),
              element: item,
              total: 0,
            };

            // Calculate initial total
            product.total = product.price * product.quantity;

            // Initialize quantity controls
            const quantityDisplays = item.querySelectorAll(".quantity-value");
            const minusBtns = item.querySelectorAll(".quantity-minus");
            const plusBtns = item.querySelectorAll(".quantity-plus");

            quantityDisplays.forEach(
              (display) => (display.textContent = product.quantity)
            );

            // Add event listeners
            minusBtns.forEach((btn) => {
              btn.addEventListener("click", function () {
                const display =
                  this.closest(".quantity-controls").querySelector(
                    ".quantity-value"
                  );
                let currentQty = parseInt(display.textContent);
                if (currentQty > 1) {
                  currentQty--;
                  display.textContent = currentQty;
                  product.quantity = currentQty;
                  product.total = product.price * currentQty;
                  updateItemTotal(item, product.total);
                  updateCartTotals();
                }
              });
            });

            plusBtns.forEach((btn) => {
              btn.addEventListener("click", function () {
                const display =
                  this.closest(".quantity-controls").querySelector(
                    ".quantity-value"
                  );
                let currentQty = parseInt(display.textContent);
                if (currentQty < product.maxQuantity) {
                  currentQty++;
                  if (currentQty == product.maxQuantity) {
                    document.querySelector(".warning-max").innerHTML = `
                      <div class="container mt-3">
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                          <strong>Warning</strong> You reached the maximum quantity.
                          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                      </div>`;
                  }
                  display.textContent = currentQty;
                  product.quantity = currentQty;
                  product.total = product.price * currentQty;
                  updateItemTotal(item, product.total);
                  updateCartTotals();
                }
              });
            });
          });

          // Add delete event listeners
          document.querySelectorAll(".delete-item").forEach((btn) => {
            btn.addEventListener("click", function () {
              const index = parseInt(this.dataset.index);
              // Remove item from cartData
              cartData.splice(index, 1);
              // Update localStorage
              localStorage.setItem("Cart", JSON.stringify(cartData));
              // Re-render cart
              renderCartItems();
              // Update totals
              updateCartTotals();
            });
          });

          // Update totals
          updateCartTotals();
        }

        // Initial render
        renderCartItems();

        // Shipping mode selection
        const shippingModes = document.querySelectorAll(".shipping-mode");
        shippingModes.forEach((mode) => {
          mode.addEventListener("change", function () {
            updateCartTotals();
          });
        });

        // Helper function to update item total display
        function updateItemTotal(item, total) {
          const totalDisplay = `${total.toFixed(2)} $`;
          item
            .querySelectorAll(".product-total")
            .forEach((el) => (el.textContent = totalDisplay));
        }

        // Calculate and update all cart totals
        function updateCartTotals() {
          // Calculate subtotal
          let subtotal = 0;
          document.querySelectorAll(".cart-item").forEach((item) => {
            const price = parseFloat(
              item.querySelector(".product-price").textContent.split(" ")[0]
            );
            const quantity = parseInt(
              item.querySelector(".quantity-value").textContent
            );
            subtotal += price * quantity;
          });

          // Get shipping cost
          let shippingCost = 0;
          const shippingMode2 = document.getElementById("shipping-mode-2");
          if (shippingMode2.checked) {
            shippingCost = 9.9;
          }

          // Calculate grand total
          const grandTotal = subtotal + shippingCost;

          // Update DOM
          document.querySelector(
            ".subtotal-amount"
          ).textContent = `${subtotal.toFixed(2)} $`;
          document.querySelector(".shipping-amount").textContent =
            shippingCost > 0 ? `${shippingCost.toFixed(2)} $` : "FREE";
          document.querySelector(
            ".grand-total-amount"
          ).textContent = `${grandTotal.toFixed(2)} $`;
        }

        // Set default shipping mode
        document.getElementById("shipping-mode-1").checked = true;
      });
    </script>
  </head>
  <body>
    <div class="container-fluid Cart-Special-BG">
      <div
        class="container-fluid border rounded bg-light d-flex flex-column p-2"
      >
        <!-- Header -->
        <div class="container mt-2">
          <div class="row align-items-center">
            <div class="col-12 col-sm-6 text-center text-sm-start">
              <img
                src="./img/logo.png"
                alt="logo"
                class="img-fluid"
                style="max-width: 120px"
              />
            </div>
            <div
              class="col-12 col-sm-6 d-flex justify-content-md-end justify-content-center"
            >
              <button class="btn btn-outline-secondary btn-sm rounded">
                <i class="fa-solid fa-arrow-left me-1"></i> Continue Shopping
              </button>
            </div>
          </div>
        </div>
        <!--End Header-->

        <!-- warning message -->
        <div class="warning-max"></div>
        <!-- End warning message -->

        <!-- Desktop Table (shown above 480px) -->
        <div class="cart-item-desktop">
          <div class="container mt-3">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th class="text-uppercase text-black-50">Product</th>
                  <th class="text-uppercase text-black-50 text-center">
                    Price
                  </th>
                  <th class="text-uppercase text-black-50 text-center">
                    Quantity
                  </th>
                  <th class="text-uppercase text-black-50 text-center">
                    Total
                  </th>
                  <th class="text-uppercase text-black-50 text-center">
                    Action
                  </th>
                </tr>
              </thead>
              <tbody id="cart-table-body">
                <!-- Cart items will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
        </div>
        <!-- End Desktop Table -->

        <!-- Mobile List (shown below 480px) -->
        <div class="cart-item-mobile">
          <div class="container mt-3" id="cart-mobile-list">
            <!-- Cart items will be dynamically inserted here -->
          </div>
        </div>
        <!-- End Mobile List -->

        <!-- Footer of Cart Page -->
        <div class="container my-3 p-3 rounded-3 bg-Cart-Footer border">
          <div class="row">
            <!-- shipping-mode -->
            <div class="col-12 col-md-8">
              <h4 class="fw-bold">Choose shipping mode:</h4>
              <div class="mt-3">
                <div class="form-check">
                  <input
                    class="form-check-input shipping-mode"
                    type="radio"
                    name="shipping-mode"
                    id="shipping-mode-1"
                    checked
                  />
                  <label class="form-check-label" for="shipping-mode-1">
                    Store pickup (In 20 min) • FREE
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input shipping-mode"
                    type="radio"
                    name="shipping-mode"
                    id="shipping-mode-2"
                  />
                  <label class="form-check-label" for="shipping-mode-2">
                    Delivery at home • 9.90$
                  </label>
                </div>
              </div>
            </div>
            <!-- End shipping-mode -->

            <div class="col-12 col-md-4 mt-3 mt-md-0">
              <!-- subtotal -->
              <div class="d-flex justify-content-between">
                <p class="text-black-50 text-uppercase mb-2">Subtotal:</p>
                <span class="fw-bold subtotal-amount">0.00 $</span>
              </div>

              <!-- shipping fees -->
              <div class="d-flex justify-content-between">
                <p class="text-black-50 text-uppercase mb-2">Shipping:</p>
                <span class="fw-bold shipping-amount">FREE</span>
              </div>

              <!-- line break -->
              <hr class="my-2" />

              <!-- total -->
              <div class="d-flex justify-content-between">
                <p class="text-black-50 text-uppercase mb-2">Total:</p>
                <span class="fw-bold fs-5 grand-total-amount">0.00 $</span>
              </div>

              <!-- checkout button -->
              <button class="btn btn-danger w-100 mt-3 text-uppercase py-2">
                Proceed to Checkout
              </button>
            </div>
          </div>
        </div>
        <!-- End Footer of Cart Page -->
      </div>
    </div>
  </body>
</html>
