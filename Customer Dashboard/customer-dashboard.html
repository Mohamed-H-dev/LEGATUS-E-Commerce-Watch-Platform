<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <!--FontAwesome  -->
    <!-- nav -->
    <link rel="stylesheet" href="../nav.css">
    <script src="../navFoterManager.js" type="module"></script>
    <style>
    *{
    margin: 0;
    padding: 0;
    }
        :root {
            --SwampTime-color: #002f5f;
            --primary-color: #dae5ef;
            --secondry-color: #002f5f;
            --dark-color: #001f3f;
        }

        body{
            background-image: linear-gradient(135deg, #dae5ef 0%, #ffffff 100%);
            height: 100%;
            
        }

        .btn-submit {
            background-color: var(--SwampTime-color);
            border: none;
            color: white;
        }

        .btn-secondary {
            background-color: var(--SwampTime-color);
            border: none;
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--dark-color);
            color: white;
        }

        .customer-name {
            color: var(--SwampTime-color);
        }

        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #28a745;
            border-radius: 50%;
            margin-left: 5px;
        }

        .navbar {
            background-color: var(--SwampTime-color) !important;
        }

        .card-header {
            background-color: var(--SwampTime-color) !important;
            color: white !important;
        }


    </style>
</head>

<body class="bg-info">
    <!-- <div class="row mb-0 px-0 width-100">
        <nav class="navbar navbar-expand-md navbar-light bg-light py-5">
            <div class="container-fluid d-flex justify-content-between">
                <h2 class="mb-0 offset-5 text-white">Customer Dashboard</h2>
            </div>
        </nav>
    </div> -->

    <special-nav></special-nav>
    <div class="container mt-4">
        <div class="row justify-content-between align-items-center g-3">
            <!-- User Info Card -->
            <div class="col-12 col-md-6 col-lg-5">
                <div class="card shadow-sm rounded-4">
                    <div class="card-body">
                        <h4 class="customer-name fw-bold mb-1" id="customerName">Loading...</h4>
                        <p class="mb-0">
                            <span id="customerEmail">Loading...</span>
                            <span class="online-indicator"></span>
                            <small class="text-muted">Online</small>
                        </p>
                    </div>
                </div>
            </div>

            <!-- sign out and manage Buttons -->
            <div class="col-12 col-md-6 col-lg-4">
                <div class="d-flex flex-column flex-md-row gap-2 justify-content-md-end">
                    <button id="toggleViewBtn" class="btn btn-secondary rounded-pill">
                        <i class="fas fa-user-cog me-2"></i>Manage Account
                    </button>
                    <button id="signOutBtn" class="btn btn-secondary rounded-pill">
                        <i class="fas fa-sign-out-alt me-2"></i>Sign Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12 col-lg-8 offset-lg-2">
                <!-- the Orders Table  -->
                <div id="ordersTable" class="card shadow-sm rounded-4">
                    <div class="card-header rounded-top-4">
                        <h5 class="mb-0">Purchase History</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="sticky-top bg-light">
                                    <tr>
                                        <th class="bg-light">Order ID</th>
                                        <th class="bg-light">Date</th>
                                        <th class="bg-light">Order Status</th>
                                        <th class="bg-light">Product details</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center">
                                            <div class="d-flex justify-content-center py-3">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Account Management Form hidden by default until it got pressed -->

                <div id="accountForm" class="card shadow-sm rounded-4" style="display: none;">
                    <div class="card-header rounded-top-4">
                        <h5 class="mb-0">Manage Account</h5>
                    </div>
                    <div class="card-body">
                        <form id="updateAccountForm">
                            <div class="mb-3">
                                <label for="fullName" class="form-label">Full name</label>
                                <input type="text" class="form-control rounded-pill" id="fullName">
                            </div>

                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control rounded-pill" id="email">
                            </div>

                            <div class="mb-4">
                                <label for="password" class="form-label">Password</label>
                                <div class="position-relative">
                                    <input type="password" class="form-control rounded-pill" id="password">
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary rounded-pill"
                                    id="cancelUpdate">Cancel</button>
                                <button type="submit" class="btn btn-submit rounded-pill">Update Account</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailsContent">
                    <!-- Order details  -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <style>
         body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        } 
         
        .container {
            flex: 1 0 auto;
        }
        
        special-footer {
            flex-shrink: 0;
            margin-top: auto;
        }
    </style>
    
    <script type="module">
        import { FormValidator } from "../Sign/Validation.js";
        import { UserManager } from "../Sign/UserManager.js";
        import { StorageManager } from "../Sign/StorageManager.js";

        document.addEventListener("DOMContentLoaded", async function () {
            try {
                // Import the required managers
                let LocalStorageManager;
                let Product;

                try {
                    const productModule = await import("./js/product.js");
                    LocalStorageManager = productModule.LocalStorageManager;
                } catch (error) {
                    console.warn("LocalStorageManager not found, using localStorage directly");
                }

                try {
                    const sellerProductModule = await import("../sellerdashboard/js/product.js");
                    Product = sellerProductModule.Product;
                } catch (error) {
                    console.warn("Product class not found, some features may be limited");
                }

                // Check if UserManager is properly initialized

                // Initialize UserManager 

                if (typeof UserManager.getCurrentUser !== 'function') {
                    throw new Error("UserManager not properly initialized");
                }



                // Check if there's a current user, if not create a default one
                //test purpose only will be deleted later

                let currentUser = UserManager.getCurrentUser();
                if (!currentUser) {
                    // Create a default user
                    const defaultUser = {
                        id: "default-user",
                        name: "Demo User",
                        email: "demo@example.com",
                        password: "demo123",
                        role: "customer"
                    };

                    // Save the default user
                    const users = StorageManager.load('users') || [];
                    users.push(defaultUser);
                    StorageManager.save('users', users);
                    StorageManager.save('currentUser', defaultUser);

                    currentUser = defaultUser;
                }
                //ends here





                const validator = new FormValidator();
                const storageManager = LocalStorageManager ? new LocalStorageManager() : null;

                // Initialize the dashboard
                initializeDashboard(storageManager, validator, Product);
            } catch (error) {
                console.error("Error initializing dashboard:", error);
                alert("Failed to load dashboard. Please try refreshing the page.");
                window.location.href = "../Sign.html";
            }
        });


        function initializeDashboard(storageManager, validator, Product) {
            try {
                // Get current customer info using static method omar storage manager 
                const currentUser = UserManager.getCurrentUser();

                if (!currentUser) {
                    // If no user is logged in, redirect to login page
                    window.location.href = "../Sign.html";
                    return;
                }

                loadCustomerInfo(currentUser);

                // Load customer orders
                loadCustomerOrders(currentUser.id, storageManager, Product);

                setupSignOutButton();

                setupAccountManagement(validator);
            } catch (error) {
                console.error("Error in dashboard initialization:", error);
                alert("Failed to initialize dashboard. Please try again.");
                window.location.href = "../Sign.html";
            }
        }


        //  Load and display customer information

        function loadCustomerInfo(user) {
            try {
                const nameElement = document.getElementById('customerName');
                const emailElement = document.getElementById('customerEmail');

                if (nameElement) nameElement.textContent = user.name || 'N/A';
                if (emailElement) emailElement.textContent = user.email || 'N/A';
            } catch (error) {
                console.error("Error loading customer info:", error);
            }
        }

        // Load and display customer orders

        function loadCustomerOrders(customerId, storageManager, Product) {
            try {
                // Get orders from localStorage
                let allOrders = [];

                if (storageManager && typeof storageManager.getOrders === 'function') {
                    allOrders = storageManager.getOrders();
                } else {
                    // Fallback if method doesn't exist or storageManager is not available

                    const ordersString = localStorage.getItem('orders');
                    allOrders = ordersString ? JSON.parse(ordersString) : [];
                }

                // Filters orders by customer ID
                const customerOrders = Array.isArray(allOrders) ?
                    allOrders.filter(order => order.customerId === customerId) : [];

                // Get reference to the table body
                const ordersTableBody = document.getElementById('ordersTableBody');
                if (!ordersTableBody) return;

                // Clear existing old rows

                ordersTableBody.innerHTML = '';



                if (customerOrders.length === 0)  // If no orders found
                {
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = `
                        <td colspan="4" class="text-center py-4">
                            No orders found
                        </td>
                    `;
                    ordersTableBody.appendChild(emptyRow);
                    return;
                }

                //could remove this if it didn't work 
                // Sort orders by date, most recent first 
                customerOrders.sort((a, b) => {
                    const dateA = a.date ? new Date(a.date) : new Date(0);
                    const dateB = b.date ? new Date(b.date) : new Date(0);
                    return dateB - dateA;
                });

                // Add orders to the table line by line 
                customerOrders.forEach(order => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.id || 'N/A'}</td>
                        <td>${formatDate(order.date)}</td>
                        <td>
                            <span class="badge ${getStatusBadgeClass(order.status)}">${order.status || 'Unknown'}</span>
                        </td>
                        <td>
                            <a href="../product-details.html?id=${order.items[0].id}" class="btn btn-sm btn-primary rounded-pill">
                                View Details
                            </a>
                        </td>
                    `;
                    ordersTableBody.appendChild(row);
                });
            } catch (error) {
                console.error("Error loading customer orders:", error);
                const ordersTableBody = document.getElementById('ordersTableBody');
                if (ordersTableBody) {
                    ordersTableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                Error loading orders. Please try again later.
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Helper function to get badge class based on status
        function getStatusBadgeClass(status) {
            switch (status?.toLowerCase()) {
                case 'delivered':
                    return 'bg-success';
                case 'processing':
                    return 'bg-warning text-dark';
                case 'shipped':
                    return 'bg-info';
                default:
                    return 'bg-secondary';
            }
        }

        //  sign out button

        function setupSignOutButton() {
            const signOutBtn = document.getElementById('signOutBtn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', function () {
                    try {
                        UserManager.logoutUser();
                        window.location.href = "../index.html";
                    } catch (error) {
                        console.error("Error during sign out:", error);
                        alert("Could not sign out. Please try again.");
                    }
                });
            }
        }

        //format date function to ensure all dates are in the same format and to avoid errors and to make it more readable
        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            } catch (error) {
                console.error("Error formatting date:", error);
                return dateString;
            }
        }

        //account management just like the one in the sign up page but with some changes to make it work with the current user and to update the local storage and to show the success message and to hide the form and show the table again
        // and to load the current user data into the form and to initialize the validator for the form
        function setupAccountManagement(validator) {
            const toggleViewBtn = document.getElementById('toggleViewBtn');
            const cancelUpdateBtn = document.getElementById('cancelUpdate');
            const updateAccountForm = document.getElementById('updateAccountForm');
            const ordersTable = document.getElementById('ordersTable');
            const accountForm = document.getElementById('accountForm');
            //switch between the two views and to show the account form and to hide the orders table and to load the current user data into the form and to initialize the validator for the form
            if (toggleViewBtn) {
                toggleViewBtn.addEventListener('click', function () {
                    if (ordersTable.style.display === 'none') {
                        // Switch to Purchase History view 
                        ordersTable.style.display = 'block';
                        accountForm.style.display = 'none';
                        toggleViewBtn.innerHTML = '<i class="fas fa-user-cog me-2"></i>Manage Account';
                    } else {
                        // Switch to Account Management view

                        ordersTable.style.display = 'none';
                        accountForm.style.display = 'block';
                        toggleViewBtn.innerHTML = '<i class="fas fa-history me-2"></i>Purchase History';
                        //from font awesome 
                        // Load current user data into form

                        const currentUser = UserManager.getCurrentUser();
                        if (currentUser) {
                            document.getElementById('fullName').value = currentUser.name || '';
                            document.getElementById('email').value = currentUser.email || '';
                        }

                        // Initialize validator for the form
                        validator.init();
                    }
                });
            }

            if (cancelUpdateBtn) {
                cancelUpdateBtn.addEventListener('click', function () {
                    // Hide account form and show orders table
                    accountForm.style.display = 'none';
                    ordersTable.style.display = 'block';
                    toggleViewBtn.innerHTML = '<i class="fas fa-user-cog me-2"></i>Manage Account';
                });
            }

            if (updateAccountForm) {
                updateAccountForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    // Validate form fields from validation.js just like sign up page
                    validator.validateName({ target: document.getElementById('fullName') });
                    validator.validateEmailField({ target: document.getElementById('email') });
                    validator.validatePasswordField({ target: document.getElementById('password') });

                    // Only proceed if all validations pass
                    if (validator.isNameValid && validator.isEmailValid && validator.isPasswordValid) {
                        try {
                            // Get current user from UserManager [omar gallo storage manager]
                            const currentUser = UserManager.getCurrentUser();
                            if (!currentUser) {
                                throw new Error("No user logged in");
                            }

                            // to Get form values
                            const updatedUser = {
                                ...currentUser, // Keep existing user data :just known this today btw 
                                name: document.getElementById('fullName').value.trim(),
                                email: document.getElementById('email').value.trim(),
                                password: document.getElementById('password').value
                            };

                            // Update user in localStorage
                            const users = StorageManager.load('users') || [];
                            const userIndex = users.findIndex(u => u.id === currentUser.id);

                            if (userIndex !== -1) {
                                users[userIndex] = updatedUser;
                                StorageManager.save('users', users);

                                // Update current user in localStorage
                                StorageManager.save('currentUser', updatedUser);

                                // Show success message

                                alert('Account updated successfully!');

                                // Hide form and show table
                                accountForm.style.display = 'none';
                                ordersTable.style.display = 'block';

                                // Update displayed user info
                                loadCustomerInfo(updatedUser);
                            } else {
                                throw new Error("User not found in database");
                            }
                        } catch (error) {
                            console.error("Error updating account:", error);
                            alert("Failed to update account. Please try again.");
                        }
                    }
                });
            }
        }
    </script>
    <special-footer></special-footer>
</body>

</html>